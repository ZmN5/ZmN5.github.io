<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>sticker on ç§Ÿå—å¢“åœ°ï¼Œä¿¯ç°å¸ˆèŒƒå­¦é™¢</title>
    <link>https://fucangyu.github.io/categories/sticker/</link>
    <description>Recent content in sticker on ç§Ÿå—å¢“åœ°ï¼Œä¿¯ç°å¸ˆèŒƒå­¦é™¢</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <lastBuildDate>Thu, 17 Jan 2019 01:03:13 +0800</lastBuildDate>
    
	<atom:link href="https://fucangyu.github.io/categories/sticker/index.xml" rel="self" type="application/rss+xml" />
    
    
    <item>
      <title>ä¸€ç§æœ‰æ„æ€çš„æ­»é”</title>
      <link>https://fucangyu.github.io/post/a-interesting-deadlock/</link>
      <pubDate>Thu, 17 Jan 2019 01:03:13 +0800</pubDate>
      
      <guid>https://fucangyu.github.io/post/a-interesting-deadlock/</guid>
      <description>&lt;p&gt;åˆšé—²é€›æ—¶å€™å‘ç°æœ‰&lt;a href=&#34;https://python-gino.readthedocs.io/zh/latest/why.html#the-story&#34;&gt;ä¸€ç¯‡æ–‡ç« &lt;/a&gt;è®²äº†ä¸€ç§æœ‰æ„æ€çš„æ­»é”ï¼Œä¸æ˜¯äº²èº«ç»å†ï¼Œä½†æ˜¯ä¹Ÿå¾ˆæœ‰æ„æ€äº†ã€‚&lt;/p&gt;

&lt;p&gt;å…ˆä¼šè®®ä¸€ä¸‹æ­»é”çš„å®šä¹‰æ˜¯ä»€ä¹ˆï¼Ÿç¿»å‡ºå‹ç®±åº•çš„&lt;code&gt;ç°ä»£æ“ä½œç³»ç»Ÿ&lt;/code&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;å¦‚æœä¸€ä¸ªè¿›ç¨‹é›†åˆä¸­çš„æ¯ä¸ªè¿›ç¨‹éƒ½åªèƒ½ç­‰å¾…ç”±è¯¥è¿›ç¨‹é›†åˆä¸­çš„å…¶ä»–è¿›ç¨‹æ‰èƒ½å¼•å‘çš„äº‹ä»¶ï¼Œé‚£ä¹ˆï¼Œè¯¥è¿›ç¨‹é›†åˆå°±æ˜¯æ­»é”çš„ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;æ‰€ä»¥ï¼Œè¿˜æ˜¯ä¸çŸ¥é“ä»€ä¹ˆæ˜¯æ­»é”ã€‚&lt;/p&gt;

&lt;p&gt;ä¸¾ä¸ªä¾‹å­ï¼Œ&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;æ¯”å¦‚ç”²ä¹™ä¸¤äººåŒæ—¶å»é£Ÿå ‚åƒé¥­ï¼Œé£Ÿå ‚é‡Œé¢åªæœ‰ä¸€ä¸ªç¢—å’Œä¸€åŒç­·å­ï¼Œç”²æŠ¢åˆ°äº†ç¢—ï¼Œä¹™æŠ¢åˆ°äº†ç­·å­ï¼Œç”²ç­‰ä¹™æ”¾ä¸‹ç­·å­ï¼Œä¹™ç­‰ç”²æ”¾ä¸‹ç¢—ï¼Œç»“æœä¸¤ä¸ªäººéƒ½é¥¿æ­»äº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;åˆæ¯”å¦‚:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Aå’ŒBä¸¤ä¸ªè¿›ç¨‹åŒæ—¶å»å†™æ•°æ®åº“ï¼ŒAé”ä½äº†ç¬¬nè¡Œå»è¯»ç¬¬mè¡Œï¼ŒBé”ä½äº†ç¬¬mè¡Œå»è¯»ç¬¬nè¡Œï¼Œç»“æœAï¼ŒBéƒ½æ— é™æœŸç­‰ä¸‹å»äº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;æ— è®ºæ˜¯&lt;code&gt;ç”²&lt;/code&gt;,&lt;code&gt;ä¹™&lt;/code&gt;,è¿˜æ˜¯&lt;code&gt;A&lt;/code&gt;,&lt;code&gt;B&lt;/code&gt;,éƒ½åœ¨ç­‰å¾…å¦ä¸€ä¸ªå·²ç»æ­»é”çš„è¿›ç¨‹é‡Šæ”¾èµ„æºã€‚å› ä¸ºæ‰€æœ‰çš„è¿›ç¨‹éƒ½ä¸èƒ½è¿è¡Œï¼Œæ‰€ä»¥èµ„æºæ°¸è¿œæ— æ³•è¢«é‡Šæ”¾ï¼Œæ‰€ä»¥æ‰€æœ‰è¿›ç¨‹éƒ½ä¸èƒ½è¢«å”¤é†’ã€‚è¿›ç¨‹çš„æ•°é‡ä»¥åŠå æœ‰å’Œè¯·æ±‚çš„èµ„æºæ•°é‡éƒ½æ˜¯æ— å…³ç´§è¦çš„ï¼Œè€Œæ— è®ºèµ„æºå’Œä½•ç§ç±»å‹éƒ½ä¼šå‘ç”Ÿä½•ç§ç»“æœï¼Œæ‰€ä»¥è¿™ç§æ­»é”è¢«ç§°ä¸ºèµ„æºæ­»é”ã€‚&lt;/p&gt;

&lt;p&gt;å¥½äº†ï¼ŒæŠ„ä¹¦ç»“æŸï¼Œåˆ’é‡ç‚¹ã€‚&lt;/p&gt;

&lt;p&gt;å¥½å§ï¼Œä¸Šé¢è¿™æ®µè¯éƒ½æ˜¯é‡ç‚¹ã€‚&lt;/p&gt;

&lt;p&gt;åºŸè¯ğŸ‘†&lt;/p&gt;

&lt;p&gt;ä¸‹é¢çœ‹&lt;code&gt;å æœ‰å’Œè¯·æ±‚çš„èµ„æºæ•°é‡éƒ½æ˜¯æ— å…³ç´§è¦çš„ğŸŒ°&lt;/code&gt;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;For example, the first coroutine starts a transaction and updated a row, then the second coroutine tries to update the same row before the first coroutine closes the transaction. The second coroutine will block the whole thread at the non-async update, waiting for the row lock to be released, but the releasing is in the first coroutine which is blocked by the second coroutine. Thus it will block forever.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä¹‹å‰åœ¨åç¨‹ä¸­ï¼Œæ¯æ—¶æ¯åˆ»å®é™…éƒ½åªæœ‰ä¸€ä»¶äº‹åœ¨æ‰§è¡Œï¼Œå‘ç”Ÿæ­»é”çš„æ¦‚ç‡åº”è¯¥ä¸é«˜å§ã€‚too youngå•Š&lt;/p&gt;

&lt;p&gt;æ¯”å¦‚ç¬¬ä¸€ä¸ªåç¨‹å‘èµ·äº‹åŠ¡æ›´æ–°æ•°æ®åº“ä¸­çš„ä¸€è¡Œï¼Œè¿™æ—¶å€™ç¬¬äºŒä¸ªåç¨‹è¯•å›¾æ›´æ–°åŒä¸€è¡Œï¼Œå¦‚æœç¬¬äºŒä¸ªåç¨‹æ˜¯éå¼‚æ­¥çš„æ›´æ–°ï¼Œé‚£ä¹ˆå®ƒå°±è¦ç­‰å¾…ç¬¬ä¸€ä¸ªåç¨‹é‡Šæ”¾èµ„æºï¼Œä½†æ˜¯è¿™æ—¶å€™æ•´ä¸ªçº¿ç¨‹å·²ç»è¢«ç¬¬äºŒä¸ªçº¿ç¨‹é˜»å¡äº†ï¼Œç¬¬ä¸€ä¸ªåç¨‹æ— æ³•é‡Šæ”¾èµ„æºï¼Œdeadlock!&lt;/p&gt;

&lt;p&gt;å›å¿†ä¸€ä¸‹ä¹¦æœ¬ä¸­å…³äºèµ„æºæ­»é”çš„å››ä¸ªæ¡ä»¶ï¼Œå›å¿†ä¸€ä¸‹:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;äº’æ–¥æ¡ä»¶&lt;/li&gt;
&lt;li&gt;å æœ‰å’Œç­‰å¾…æ¡ä»¶&lt;/li&gt;
&lt;li&gt;ä¸å¯æŠ¢å æ¡ä»¶&lt;/li&gt;
&lt;li&gt;ç¯è·¯ç­‰å¾…æ¡ä»¶&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;è¿™å››ä¸ªæ¡ä»¶åªè¦æœ‰ä¸€ä¸ªä¸æˆç«‹é‚£ä¹ˆèµ„æºæ­»é”å°±ä¸ä¼šå‘ç”Ÿã€‚&lt;/p&gt;

&lt;p&gt;å¥½äº†ç°åœ¨å¥—ç”¨ä¸€ä¸‹ä¸Šé¢è¿™ä¸ªä¾‹å­ã€‚&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;æ•°æ®åº“è¡Œé”å’Œå½“å‰çº¿ç¨‹æ‰§è¡Œéƒ½æ˜¯äº’æ–¥çš„ï¼Œâœ…&lt;/li&gt;
&lt;li&gt;ç¬¬ä¸€ä¸ªåç¨‹å æœ‰äº†æ•°æ®åº“ä¸­çš„é”ç­‰å¾…çº¿ç¨‹æ‰§è¡Œæƒï¼Œç¬¬äºŒä¸ªåç¨‹å æœ‰äº†å½“å‰åç¨‹çš„æ‰§è¡Œç­‰å¾…è¡Œé”ï¼Œâœ…&lt;/li&gt;
&lt;li&gt;ä¸å¯æŠ¢å ï¼Œâœ…&lt;/li&gt;
&lt;li&gt;ç¯è·¯ç­‰å¾…ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹ç­‰å¾…è¡Œé”ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…æœ‰æœºä¼šè¢«æ‰§è¡Œï¼Œâœ…&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;æ­»é”bingo!&lt;/p&gt;

&lt;p&gt;æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;A simple fix would be to defer the database operations into threads, so that they won&amp;rsquo;t block the main thread, thus won&amp;rsquo;t cause a dead lock easily. It usually works and there is even a library to do so. However when it comes to ORM, things become dirty.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;æŠŠæ•°æ®åº“ç›¸å…³æ“ä½œæ‰”ç»™å…¶ä»–çº¿ç¨‹å»æ‰§è¡Œï¼Œç¡®ä¿ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹å°±è¡Œäº†ã€‚&lt;/p&gt;

&lt;p&gt;ä½†æ˜¯çœŸçš„å°±è¡Œäº†å—ï¼Ÿ&lt;/p&gt;

&lt;p&gt;åœ¨ä¸€ä¸ªå¤æ‚çš„é¡¹ç›®ä¸­ï¼Œä½ æ°¸è¿œä¸çŸ¥é“å“ªä¸€è¡Œä»£ç ä¼šè°ƒç”¨åŒæ­¥ä»£ç é˜»å¡ä¸»çº¿ç¨‹ï¼Œ&lt;code&gt;Racing condition just happens under pressure, and anything that may block will eventually block&lt;/code&gt;, å¯èƒ½ä¼šå‘ç”Ÿçš„äº‹æƒ…ç»ˆå°†è¦å‘ç”Ÿã€‚&lt;/p&gt;

&lt;p&gt;æ‰€ä»¥ä½œè€…å»ºè®®:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;This is usually the time when I suggest to separate the server into two parts: &amp;ldquo;normal blocking with ORM&amp;rdquo; and &amp;ldquo;asynchronous without ORM&amp;rdquo;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;ä¸è¿‡å€’æ˜¯æƒ³èµ·å¦å¤–ä¸€ä¸ªé—®é¢˜äº†, ç°åœ¨å…¬å¸ä¸šåŠ¡éƒ½æ˜¯ç”¨çš„&lt;code&gt;gunicorn&lt;/code&gt;+&lt;code&gt;gevent&lt;/code&gt;, è¿™ä¸ªå†…éƒ¨æ˜¯æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜çš„å‘¢&lt;/p&gt;

&lt;p&gt;å¯ä»¥çŒœæµ‹ä¸€ä¸‹ï¼š&lt;/p&gt;

&lt;p&gt;ä¸Šé¢çš„ä¾‹å­é€ æˆæ­»é”æ˜¯å› ä¸ºæœ‰åç¨‹è°ƒç”¨åŒæ­¥æ“ä½œ, è€Œgeventæ˜¯é€šè¿‡&lt;code&gt;monkey_path&lt;/code&gt;çš„æ“ä½œä»åº•å±‚æ”¹å˜æ‰€æœ‰è¯·æ±‚çš„è¡Œä¸ºï¼Œå°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜äº†ã€‚&lt;/p&gt;

&lt;p&gt;ä¸è¿‡è¿˜æœ‰å…¶ä»–é—®é¢˜ã€‚&lt;/p&gt;

&lt;p&gt;&lt;code&gt;monkey_patch&lt;/code&gt;é’ˆå¯¹Pythonä»£ç æœ‰æ•ˆï¼Œå¦‚æœæ•°æ®åº“è¿æ¥å™¨ç”¨çš„æ˜¯cæ‰©å±•ï¼Œemmm&amp;hellip;å¯ä»¥å¤§èƒ†çš„çŒœæµ‹ä¸€ä¸‹å¯èƒ½çš„bug&lt;/p&gt;

&lt;p&gt;å‚è€ƒèµ„æ–™ï¼š&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;ç°ä»£æ“ä½œç³»ç»Ÿ&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://python-gino.readthedocs.io/zh/latest/why.html#the-story&#34;&gt;https://python-gino.readthedocs.io/zh/latest/why.html#the-story&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;</description>
    </item>
    
  </channel>
</rss>